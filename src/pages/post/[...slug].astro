---
import '~/styles/mdx.css';

import { type CollectionEntry, getCollection } from 'astro:content';
import { format } from 'date-fns';

import BaseNav from '~/components/base-nav';
import MediumZoomScript from '~/components/medium-zoom-script.astro';
import TableOfContent from '~/components/table-of-content';
import ThemeToggle from '~/components/theme-toggle';
import Main from '~/layouts/main.astro';
import { parseToc, sortCollectionDateAsc } from '~/libs/mdx';
import { isDev } from '~/libs/utils';

export async function getStaticPaths() {
  const [writings, notes] = await Promise.all([
    getCollection('writing'),
    getCollection('note'),
  ]);

  return [
    ...writings.sort(sortCollectionDateAsc),
    ...notes.sort(sortCollectionDateAsc),
  ]
    .filter((post) => isDev || !post.data.draft)
    .map((post, index, list) => ({
      params: { slug: post.slug },
      props: {
        post,
        prevPost: list[index - 1],
        nextPost: list[index + 1],
      },
    }));
}

type Props = {
  post: CollectionEntry<'writing'>;
  prevPost: CollectionEntry<'writing'>;
  nextPost: CollectionEntry<'writing'>;
};

const { post, prevPost, nextPost } = Astro.props;

const { Content } = await post.render();
const { title, description, date } = post.data;
const toc = parseToc(post.body);
---

<Main seo={{ title, description }}>
  <BaseNav href={`/${post.collection}`} client:visible>
    <TableOfContent
      data-animate
      className="mt-[60px] px-2 text-sm md:hidden"
      toc={toc}
      client:load
    />
  </BaseNav>
  <header class="mb-7 font-serif">
    <div class="flex items-center">
      <h1 class="-mb-0.5 font-semibold leading-7 text-heading">{title}</h1>
      <div class="ml-auto">
        <ThemeToggle client:load />
      </div>
    </div>
    <time class="text-sm text-second">
      {format(date, 'MMM dd, yyyy')}
    </time>
  </header>
  <article data-animate data-animate-speed="fast" class="mdx">
    <Content />
  </article>
  <footer class="mt-page">
    <hr class="mb-7" />
    <footer class="text-tx flex items-stretch justify-between gap-1 text-sm">
      {
        !!prevPost && (
          <a class="group flex flex-col gap-1" href={`/post/${prevPost.slug}`}>
            <div class="text-disabled transition-colors group-hover:text-second">
              Previous
            </div>
            <span class="text-second transition-colors group-hover:text-heading">
              {prevPost.data.title}
            </span>
          </a>
        )
      }
      {
        !!nextPost && (
          <a
            class="group ml-auto flex flex-col gap-1 text-right text-second hover:text-body"
            href={`/post/${nextPost.slug}`}
          >
            <div class="text-disabled transition-colors group-hover:text-second">
              Next
            </div>
            <span class="text-second transition-colors group-hover:text-heading">
              {nextPost.data.title}
            </span>
          </a>
        )
      }
    </footer>
  </footer>
  <MediumZoomScript />
</Main>
