---
title: '(Astro) 전역 상태를 곁들여 다크모드 관리하기'
description: ''
date: 2024-02-07 21:41:57
draft: false
tags:
  - astro
  - nanostores
  - global state
  - react
  - svelte
  - darkmode
---

import ThemeDropdownSvelte from '~/components/theme-dropdown.svelte';
import ThemeDropdown from '~/components/theme-dropdown.tsx';

지난 [(Astro) 다크모드 적용하기](./astro-darkmode) 글에 이어서 Astro에 전역 상태를 곁들어 다크모드를 어떻게 적용하면 좋을지 살펴봅시다.

- 현 테마를 전역 상태로 관리하기
- 테마에 system 선택지 추가하기
- React, Svelte 컴포넌트에 전역 상태 구독하기

## 상태 관리 라이브러리 - nanostores

Astro의 큰 매력 중의 하나는 React, Vue, Svelte, Solid 등 여러 웹 프레임워크를 사용할 수 있는 점입니다. 하지만 다른 프레임워크의 컴포넌트가 같은 상태를 공유한다는 것은 꽤나 생소한 영역입니다.

[Astro 공식문서](https://docs.astro.build/en/recipes/sharing-state)에서 권장하는 전역 상태 관리 라이브러리 [nanostores](https://github.com/nanostores/nanostores#nano-stores)를 활용해 봅시다.

```shell
bun add nanostores @nanostores/persistent @nanostores/react
```

TODO: `nanostores`애 대한 소개

- recoil, jotai과 비슷한 atomic store
- 간편하고 깔쌈함

TODO: `@nanostores/persistent`에 대한 소개

TODO: `@nanostores/react`에 대한 소개

## 전역 상태 선언하기

```ts title="libs/stores/theme.ts" {15-19}
import { persistentAtom } from '@nanostores/persistent';

import { changeGiscusTheme } from '~/components/giscus';

export const THEME_MAP = {
  light: 'light',
  dark: 'dark',
  system: undefined,
} as const;

export type ThemeKey = keyof typeof THEME_MAP;
export type ThemeValue = (typeof THEME_MAP)[ThemeKey];

export const STORAGE_THEME_KEY = 'theme' as const;
export const theme$ = persistentAtom<ThemeValue>(
  STORAGE_THEME_KEY,
  THEME_MAP.system,
);
```

TODO: `theme$`로 쓰는 이유, `$theme`를 쓰지 않는 이유

## 전역 상태 구독하기

TODO: theme이 변경될 때 `<html>` 태그에 `.dark` 클리스를 추가

```ts title="libs/stores/theme.ts"
// ...

const initThemeSubscribe = () => {
  const applyTheme = (theme: ThemeValue) => {
    if (theme === THEME_MAP.dark) {
      document.documentElement.classList.add('dark');
    } else if (theme === THEME_MAP.light) {
      document.documentElement.classList.remove('dark');
    }
  };

  const handleMediaQuery = (query: { matches: boolean }) => {
    applyTheme(query.matches ? 'dark' : 'light');
  };

  theme$.subscribe((theme) => {
    if (theme !== THEME_MAP.system) {
      applyTheme(theme);
      return;
    }

    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    mediaQuery.removeEventListener('change', handleMediaQuery);
    mediaQuery.addEventListener('change', handleMediaQuery);
    handleMediaQuery(mediaQuery);
  });
};
```

TODO: `onMount`에 대한 설명
TODO: `allTasks`에 대한 설명

```ts title="libs/stores/theme.ts"
import { allTasks, onMount } from 'nanostores';

//...

// to avoid SSR
await allTasks();

onMount(theme$, initThemeSubscribe);
```

TODO: 마법과 같은 동작을 신뢰할 수 없다면?

```astro title="theme-footer-script.astro"
<script>
  import { initThemeSubscribe } from '~/libs/stores/theme';

  initThemeSubscribe();
</script>
```

```astro title="main.astro"
---
// ...
import ThemeFooterScript from '~/components/theme-footer-script.astro';
---

<html>
  <!-- ... -->
  <body>
    <!-- ... -->
    <ThemeFooterScript />
  </body>
</html>
```

TODO: Astro에서 번들링 최적화 함

## React

TODO: `useStore`로 상태 리렌더링 적용
TODO: `theme$.set`으로 상태 수정

```tsx title="theme-dropdown.tsx" {6, 13, 16}
import { useStore } from '@nanostores/react';
// ...
import { THEME_MAP, theme$ } from '~/libs/stores/theme';

export default function ThemeDropdown() {
  const theme = useStore(theme$);

  return (
    <DropdownMenu>
      {/* ... */}
      <DropdownMenuItem
        className="justify-between"
        onClick={() => theme$.set(THEME_MAP.light)}
      >
        Light
        {theme === THEME_MAP.light && <DotIcon />}
      </DropdownMenuItem>
    </DropdownMenu>
  );
}
```

[코드 원본 보기](https://github.com/bepyan/bepyan.me.v2/tree/main/src/components/theme-dropdown.tsx)

## Svelte

TODO: Astro에서 Svelte 세팅하는 법

[@astrojs/svelte](https://docs.astro.build/ko/guides/integrations-guide/svelte/)

```shell
bun add svelte @astrojs/svelte
```

```js title="astro.config.mjs"
import { defineConfig } from 'astro/config';
import svelte from '@astrojs/svelte';

export default defineConfig({
  // ...
  integrations: [svelte()],
});
```

TODO: 별다른 세팅없이 바로 svelte의 `reactive` 문법을 사용 가능

```svelte title="theme-dropdown.svelte"
<script>
  import { THEME_MAP, theme$ } from '~/libs/stores/theme';
  import { cn } from '~/libs/utils';

  let isDropdownOpen = false;

  const handleDropdownClick = () => {
    isDropdownOpen = !isDropdownOpen;
  };

  const handleDropdownFocusLoss = ({ relatedTarget, currentTarget }) => {
    if (
      relatedTarget instanceof HTMLElement &&
      currentTarget.contains(relatedTarget)
    ) {
      return;
    }

    isDropdownOpen = false;
  };

  const handleItemClick = (theme) => {
    $theme$ = theme;
    isDropdownOpen = false;
  };
</script>

<div
  class="font-sans font-normal relative text-sm"
  on:focusout={handleDropdownFocusLoss}
>
  <button
    class="h-9 w-16 rounded-md capitalize transition-color focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-gray-200 hover:bg-selection hover:text-gray-900"
    on:click={handleDropdownClick}
  >
    {THEME_MAP[$theme$] ?? 'system'}
  </button>
  <div
    class={cn(
      'z-50 absolute top-full mt-1 flex flex-col min-w-[8rem] overflow-hidden rounded-md border bg-page p-1 shadow-md',
      !isDropdownOpen && 'invisible',
    )}
  >
    {#each Object.keys(THEME_MAP) as themeKey}
      <button
        class={cn(
          'w-full text-left capitalize px-2 py-1.5 rounded-sm hover:bg-selection',
          $theme$ === THEME_MAP[themeKey] && 'font-semibold',
        )}
        on:click={() => handleItemClick(THEME_MAP[themeKey])}
      >
        {themeKey}
      </button>
    {/each}
  </div>
</div>
```

[코드 원본 보기](https://github.com/bepyan/bepyan.me.v2/tree/main/src/components/theme-dropdown.svelte)

## 맺으면서

<div class="flex items-center gap-2">
  <div class="text-center">
    React
    <ThemeDropdown client:load />
  </div>
  <div class="text-center">
    Svelte
    <ThemeDropdownSvelte client:load />
  </div>
</div>
